# é‡è¦æ›´æ–°è¯´æ˜ - FoundationModels API

## ğŸ“Œ æ›´æ–°æ¦‚è¿°

å·²å°†é¡¹ç›®å‡çº§ä¸ºä½¿ç”¨ FoundationModels çš„**æ­£ç¡® API**ï¼š`streamResponse(to:generating:includeSchemaInPrompt:options:)`

## ğŸ”„ ä¸»è¦å˜æ›´

### 1. æ¶æ„è°ƒæ•´

#### ä¹‹å‰ âŒ
```swift
// é”™è¯¯ï¼šå°è¯•åœ¨ @Model class ä¸Šä½¿ç”¨ @Guide
@Model
final class Expense {
    @Guide(description: "...")  // ä¸å…¼å®¹ï¼
    var date: Date
}
```

#### ç°åœ¨ âœ…
```swift
// æ­£ç¡®ï¼šåˆ†ç¦» AI ç”Ÿæˆå±‚å’ŒæŒä¹…åŒ–å±‚

// AI ç”Ÿæˆå±‚ - @Generable struct
@Generable
struct ExpenseInfo: Identifiable {
    @Guide(description: "æ¶ˆè´¹æ—¥æœŸï¼ŒISO8601 æ ¼å¼")
    var date: String?
    // ... å…¶ä»–å­—æ®µ
}

// æŒä¹…åŒ–å±‚ - @Model class
@Model
final class Expense {
    var date: Date
    // ... å…¶ä»–å­—æ®µ
}
```

### 2. API è°ƒç”¨æ–¹å¼

#### ä¹‹å‰ âŒ
```swift
// ä½¿ç”¨ generateText() ç”Ÿæˆæ–‡æœ¬ï¼Œç„¶åæ‰‹åŠ¨è§£æ JSON
var fullResponse = ""
for try await chunk in session.generateText(prompt: prompt) {
    fullResponse += chunk.text
}
let data = cleanedResponse.data(using: .utf8)
let expenseInfo = try decoder.decode(ExpenseInfo.self, from: data)
```

#### ç°åœ¨ âœ…
```swift
// ä½¿ç”¨ streamResponse() ç›´æ¥ç”Ÿæˆç»“æ„åŒ–æ•°æ®
let responseStream = session.streamResponse(
    to: userPrompt,
    generating: [ExpenseInfo].self  // ç›´æ¥æŒ‡å®šè¾“å‡ºç±»å‹
)

for try await partialResult in responseStream {
    result = partialResult.output.first  // å·²ç»æ˜¯ç»“æ„åŒ–çš„å¯¹è±¡
}
```

## ğŸ“Š æ¶æ„å¯¹æ¯”

### æ—§æ¶æ„æµç¨‹
```
ç”¨æˆ·è¾“å…¥
  â†“
OCR è¯†åˆ«
  â†“
AI ç”Ÿæˆæ–‡æœ¬ï¼ˆJSON å­—ç¬¦ä¸²ï¼‰
  â†“
æ‰‹åŠ¨æ¸…ç†æ–‡æœ¬
  â†“
JSON è§£æ
  â†“
ExpenseInfo struct
  â†“
å¡«å……åˆ° UI
```

**é—®é¢˜**ï¼š
- âŒ JSON è§£æå®¹æ˜“å‡ºé”™
- âŒ éœ€è¦æ‰‹åŠ¨æ¸…ç† AI è¾“å‡º
- âŒ æ ¼å¼ä¸è§„èŒƒæ—¶ä¼šå¤±è´¥
- âŒ æ²¡æœ‰åˆ©ç”¨ FoundationModels çš„ç»“æ„åŒ–è¾“å‡ºèƒ½åŠ›

### æ–°æ¶æ„æµç¨‹
```
ç”¨æˆ·è¾“å…¥
  â†“
OCR è¯†åˆ«
  â†“
AI ç”Ÿæˆç»“æ„åŒ–æ•°æ®ï¼ˆç›´æ¥è¾“å‡º ExpenseInfoï¼‰
  â†“
å¡«å……åˆ° UI
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
- âœ… æ— éœ€æ‰‹åŠ¨è§£æ JSON
- âœ… AI ç†è§£ @Guide æè¿°ï¼Œè¾“å‡ºæ›´å‡†ç¡®
- âœ… åˆ©ç”¨ FoundationModels çš„åŸç”Ÿèƒ½åŠ›
- âœ… ä»£ç æ›´ç®€æ´å¯é 

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µ

### @Generable å®

ç”¨äºæ ‡è®°å¯è¢« AI ç”Ÿæˆçš„ structï¼š

```swift
@Generable
struct ExpenseInfo: Identifiable {
    var id: Int
    // å¿…é¡»å®ç° Identifiable
}
```

**è¦æ±‚**ï¼š
- å¿…é¡»æ˜¯ `struct`ï¼ˆä¸èƒ½æ˜¯ classï¼‰
- å¿…é¡»å®ç° `Identifiable` åè®®
- å­—æ®µå¯ä»¥ä½¿ç”¨ `@Guide` æ·»åŠ æè¿°

### @Guide å®

ä¸ºå­—æ®µæä¾›è¯´æ˜ï¼Œå¸®åŠ© AI ç†è§£å¦‚ä½•å¡«å……æ•°æ®ï¼š

```swift
@Guide(description: "æ¶ˆè´¹æ—¥æœŸï¼ŒISO8601 æ ¼å¼ï¼Œä¾‹å¦‚ï¼š2025-10-28T14:30:00Z")
var date: String?
```

**æœ€ä½³å®è·µ**ï¼š
- æ˜ç¡®æ ¼å¼è¦æ±‚
- æä¾›ç¤ºä¾‹å€¼
- è¯´æ˜å–å€¼èŒƒå›´
- è§£é‡Šå­—æ®µå«ä¹‰

### streamResponse API

ç”Ÿæˆç»“æ„åŒ–è¾“å‡ºçš„æ ¸å¿ƒ APIï¼š

```swift
func streamResponse<Content>(
    to prompt: Prompt,
    generating type: Content.Type = Content.self,
    includeSchemaInPrompt: Bool = true,
    options: GenerationOptions = GenerationOptions()
) -> sending LanguageModelSession.ResponseStream<Content> where Content : Generable
```

**å…³é”®å‚æ•°**ï¼š
- `to`: ç”¨æˆ·æç¤ºè¯
- `generating`: è¾“å‡ºç±»å‹ï¼ˆå¿…é¡»æ˜¯æ•°ç»„ï¼Œå¦‚ `[ExpenseInfo].self`ï¼‰
- `includeSchemaInPrompt`: æ˜¯å¦åœ¨æç¤ºè¯ä¸­åŒ…å« schemaï¼ˆé»˜è®¤ trueï¼‰
- `options`: ç”Ÿæˆé€‰é¡¹

## ğŸ“ æ–‡ä»¶å˜æ›´

### ä¿®æ”¹çš„æ–‡ä»¶

#### 1. `Services/AIExpenseAnalyzer.swift`

**ä¸»è¦å˜æ›´**ï¼š
- âœ… `ExpenseInfo` æ”¹ä¸º `@Generable struct`
- âœ… æ·»åŠ  `@Guide` æè¿°åˆ°æ¯ä¸ªå­—æ®µ
- âœ… å®ç° `Identifiable` åè®®
- âœ… ä½¿ç”¨ `streamResponse` æ›¿ä»£ `generateText`
- âœ… ç§»é™¤æ‰‹åŠ¨ JSON è§£æä»£ç 
- âœ… æ›´æ–°é”™è¯¯å¤„ç†

#### 2. `Models/Expense.swift`

**ä¸»è¦å˜æ›´**ï¼š
- âœ… ç§»é™¤ `import FoundationModels`
- âœ… ç§»é™¤ `@Guide` å®ï¼ˆåªåœ¨ @Model ä¸Šä¸æ”¯æŒï¼‰
- âœ… ä¿æŒ `@Model class` ç”¨äº SwiftData

### æ–°å¢çš„æ–‡ä»¶

#### `FOUNDATION_MODELS_GUIDE.md`

å®Œæ•´çš„ FoundationModels API ä½¿ç”¨æŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š
- @Generable å’Œ @Model çš„åŒºåˆ«
- streamResponse API è¯¦è§£
- @Guide æœ€ä½³å®è·µ
- å®Œæ•´ç¤ºä¾‹ä»£ç 
- å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ
- æ€§èƒ½ä¼˜åŒ–å»ºè®®

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### åœ¨é¡¹ç›®ä¸­ä½¿ç”¨

1. **å®šä¹‰ @Generable struct**ï¼ˆå·²å®Œæˆï¼‰
```swift
@Generable
struct ExpenseInfo: Identifiable {
    var id: Int
    @Guide(description: "...")
    var date: String?
    // ...
}
```

2. **è°ƒç”¨ AI åˆ†æ**ï¼ˆæ— éœ€ä¿®æ”¹è°ƒç”¨ä»£ç ï¼‰
```swift
let expenseInfo = try await AIExpenseAnalyzer.shared.analyzeExpense(from: text)
```

3. **ä½¿ç”¨ç”Ÿæˆçš„æ•°æ®**ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
```swift
if let dateString = expenseInfo.date {
    // ä½¿ç”¨æ•°æ®
}
```

### æ•°æ®æµç¨‹

```
è´¦å•å›¾ç‰‡
    â†“
OCRService.recognizeText()
    â†“ (è¿”å› String)
AIExpenseAnalyzer.analyzeExpense()
    â†“ (è¿”å› ExpenseInfo - @Generable struct)
å¡«å……åˆ° AddExpenseView çš„è¡¨å•
    â†“ (ç”¨æˆ·ç¡®è®¤/ä¿®æ”¹)
åˆ›å»º Expense å¯¹è±¡ (@Model class)
    â†“
SwiftData æŒä¹…åŒ–
```

## ğŸ’¡ ä¼˜åŠ¿æ€»ç»“

### 1. ç±»å‹å®‰å…¨
- ç¼–è¯‘æ—¶æ£€æŸ¥å­—æ®µç±»å‹
- è‡ªåŠ¨è¡¥å…¨æ”¯æŒ
- å‡å°‘è¿è¡Œæ—¶é”™è¯¯

### 2. ä»£ç ç®€æ´
```swift
// ä¹‹å‰ï¼š~50 è¡Œï¼ˆJSON è§£æ + æ¸…ç†ï¼‰
// ç°åœ¨ï¼š~20 è¡Œï¼ˆç›´æ¥è·å–ç»“æ„åŒ–æ•°æ®ï¼‰
```

### 3. æ›´å‡†ç¡®çš„è¾“å‡º
- AI ç†è§£ @Guide æè¿°
- ç›´æ¥ç”Ÿæˆç›®æ ‡æ ¼å¼
- æ— éœ€ä¸­é—´ JSON è½¬æ¢

### 4. æ›´å¥½çš„é”™è¯¯å¤„ç†
- æ˜ç¡®çš„é”™è¯¯ç±»å‹
- æµå¼å¤„ç†æ”¯æŒ
- ä¼˜é›…çš„å¤±è´¥å¤„ç†

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [FOUNDATION_MODELS_GUIDE.md](FOUNDATION_MODELS_GUIDE.md) - **å¼ºçƒˆæ¨èé˜…è¯»**
- [Apple å®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/foundationmodels/languagemodelsession/streamresponse(to:generating:includeschemainprompt:options:))
- [PROJECT_SUMMARY.md](PROJECT_SUMMARY.md) - æŠ€æœ¯æ¶æ„æ€»ç»“

## âš ï¸ æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§
- éœ€è¦ iOS 26.0+
- éœ€è¦ Xcode 16.0+
- éœ€è¦æ”¯æŒ FoundationModels çš„è®¾å¤‡

### è¿ç§»æç¤º

å¦‚æœä½ åŸºäºæ—§ç‰ˆæœ¬ä¿®æ”¹äº†ä»£ç ï¼š

1. **ä¸è¦åœ¨ @Model class ä¸Šä½¿ç”¨ @Guide**
   - @Guide åªèƒ½ç”¨äº @Generable struct

2. **generating å‚æ•°å¿…é¡»æ˜¯æ•°ç»„**
   - `[ExpenseInfo].self` âœ…
   - `ExpenseInfo.self` âŒ

3. **ä¿æŒæ•°æ®åˆ†ç¦»**
   - ExpenseInfo: AI ç”Ÿæˆï¼ˆ@Generable structï¼‰
   - Expense: æ•°æ®å­˜å‚¨ï¼ˆ@Model classï¼‰

## ğŸ‰ æ€»ç»“

è¿™æ¬¡æ›´æ–°å°†é¡¹ç›®å‡çº§ä¸ºä½¿ç”¨ FoundationModels çš„**æ­£ç¡®ä¸”æ¨èçš„ API**ï¼Œå¸¦æ¥äº†ï¼š

- âœ… æ›´ç®€æ´çš„ä»£ç 
- âœ… æ›´å¯é çš„è¾“å‡º
- âœ… æ›´å¥½çš„ç±»å‹å®‰å…¨
- âœ… æ›´å‡†ç¡®çš„ AI ç†è§£
- âœ… æ›´ä¼˜é›…çš„æ¶æ„

**æ¨èæ‰€æœ‰å¼€å‘è€…ä»”ç»†é˜…è¯» [FOUNDATION_MODELS_GUIDE.md](FOUNDATION_MODELS_GUIDE.md) ä»¥å……åˆ†ç†è§£æ–°æ¶æ„ï¼**

---

æ›´æ–°æ—¥æœŸï¼š2025-10-28

