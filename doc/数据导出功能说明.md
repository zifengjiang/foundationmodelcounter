# 数据导出功能说明

本文档说明记账应用的数据导出功能实现细节和使用方法。

## 📦 功能概述

数据导出功能将所有账目记录导出为一个压缩包（ZIP文件），包含：
1. **CSV文件**：账目数据的表格格式
2. **图片文件夹**：所有账单图片，按时间和金额命名

## 🎯 核心特性

### 1. 智能命名
- **图片命名规则**：`yyyyMMdd_HHmmss_金额.jpg`
  - 例如：`20251030_143025_58_50.jpg` 表示 2025年10月30日 14:30:25 的 58.50元账单图片
- **压缩包命名规则**：`账目导出_yyyyMMdd_HHmmss.zip`
  - 例如：`账目导出_20251030_143500.zip`

### 2. CSV格式
CSV文件包含以下字段：
```csv
日期,交易类型,金额,货币,大类,小类,商户,备注,图片文件名
2025-10-30 14:30:25,支出,58.50,CNY,餐饮,午餐,麦当劳,工作日午餐,20251030_143025_58_50.jpg
```

#### 字段说明
| 字段 | 说明 | 示例 |
|------|------|------|
| 日期 | 交易日期和时间 | 2025-10-30 14:30:25 |
| 交易类型 | 支出或收入 | 支出 |
| 金额 | 交易金额（保留2位小数）| 58.50 |
| 货币 | 货币代码 | CNY |
| 大类 | 账目大类 | 餐饮 |
| 小类 | 账目小类 | 午餐 |
| 商户 | 商户名称 | 麦当劳 |
| 备注 | 用户备注 | 工作日午餐 |
| 图片文件名 | 对应的图片文件名 | 20251030_143025_58_50.jpg |

### 3. 数据完整性
- ✅ 包含所有历史记录
- ✅ 图片以原始质量保存（JPEG格式）
- ✅ CSV使用UTF-8编码，兼容Excel、Numbers等软件
- ✅ 特殊字符自动转义（逗号、引号、换行符）

## 🛠️ 技术实现

### 核心类：DataExportService

#### 主要方法

```swift
// 导出所有数据
func exportData(expenses: [Expense]) async throws -> URL
```

#### 实现流程

```
1. 创建临时目录
   ├── 账目数据.csv
   └── images/
       ├── 20251030_143025_58_50.jpg
       ├── 20251030_151230_120_00.jpg
       └── ...

2. 生成CSV文件
   - 遍历所有账目
   - 格式化数据
   - 转义特殊字符
   - 写入CSV文件

3. 导出图片
   - 提取图片数据
   - 按规则命名
   - 保存到images目录

4. 创建ZIP压缩包
   - 使用NSFileCoordinator
   - .forUploading选项自动创建ZIP
   - 返回压缩包URL

5. 清理临时文件
   - 删除临时目录
   - 保留压缩包供分享
```

### 关键技术点

#### 1. ZIP创建
使用iOS系统的`NSFileCoordinator`自动创建ZIP：
```swift
NSFileCoordinator().coordinate(
    readingItemAt: sourceDir,
    options: [.forUploading],
    error: &coordinatorError
) { (zipURL) in
    // zipURL 就是系统自动创建的ZIP文件
}
```

#### 2. CSV转义
处理特殊字符，确保CSV格式正确：
```swift
private func escapeCsvField(_ field: String) -> String {
    if field.contains(",") || field.contains("\"") || field.contains("\n") {
        let escaped = field.replacingOccurrences(of: "\"", with: "\"\"")
        return "\"\(escaped)\""
    }
    return field
}
```

#### 3. 异步处理
使用Swift Concurrency确保UI响应：
```swift
Task {
    await exportData()
}
```

## 📱 用户使用流程

### 1. 触发导出
在"设置"页面点击"导出数据"按钮

### 2. 导出过程
- 显示加载动画
- 后台处理数据
- 生成压缩包

### 3. 分享选项
- 自动打开系统分享表单
- 可以分享到：
  - 隔空投送
  - 文件App
  - 邮件
  - 微信/QQ
  - iCloud Drive
  - 其他支持文件的App

### 4. 状态提示
- ✅ 成功：触觉反馈 + 分享表单
- ❌ 失败：错误提示弹窗
- 📊 显示记录总数

## 🎨 界面优化

### 导出按钮状态
```
┌─────────────────────────────┐
│ 📤 导出数据         →       │  正常状态
├─────────────────────────────┤
│ ⏳ 导出数据                │  导出中（禁用）
├─────────────────────────────┤
│ ℹ️  暂无数据可导出          │  空数据提示
└─────────────────────────────┘
```

### Footer信息
显示当前可导出的记录数量：
```
导出账目数据和图片为压缩包，共 156 条记录
```

## 📊 压缩包结构示例

```
账目导出_20251030_143500.zip
├── 账目数据.csv
└── images/
    ├── 20251030_083015_15_00.jpg
    ├── 20251030_120530_45_80.jpg
    ├── 20251030_143025_58_50.jpg
    ├── 20251030_183545_120_00.jpg
    └── 20251030_204220_35_50.jpg
```

## 🔒 隐私和安全

- ✅ 数据仅在本地处理
- ✅ 不上传到任何服务器
- ✅ 用户完全控制导出数据的去向
- ✅ 临时文件自动清理
- ✅ 压缩包在分享后可手动删除

## 💡 使用建议

### 适用场景
1. **定期备份**：每月导出一次，保存到iCloud
2. **数据迁移**：换设备时导出数据
3. **报表分析**：导入Excel进行深度分析
4. **财务审计**：提供完整的账目记录
5. **数据归档**：长期保存历史数据

### Excel/Numbers使用
1. 解压ZIP文件
2. 打开"账目数据.csv"
3. 数据已按时间倒序排列
4. 可以创建数据透视表、图表等

### 注意事项
- 导出过程需要一定时间，取决于记录数量
- 图片较多时，压缩包可能较大
- 建议定期导出，避免数据丢失
- 可以将导出文件保存到iCloud Drive进行云备份

## 🐛 故障排除

### 问题：导出按钮显示禁用
**原因**：没有可导出的数据  
**解决**：添加至少一条账目记录

### 问题：导出失败
**原因**：存储空间不足或权限问题  
**解决**：
1. 检查设备存储空间
2. 重新安装应用
3. 重启设备后重试

### 问题：CSV乱码
**原因**：使用了不支持UTF-8的软件打开  
**解决**：
- Windows Excel：导入时选择UTF-8编码
- Mac Numbers：自动识别，无需设置
- 或使用记事本/文本编辑器先打开查看

## 🔄 版本历史

### v1.0.0 (2025-10-30)
- ✅ 实现基础导出功能
- ✅ CSV格式支持
- ✅ 图片智能命名
- ✅ ZIP压缩打包
- ✅ 系统分享集成
- ✅ 错误处理和用户反馈

## 📮 技术支持

如有问题或建议，欢迎反馈。

