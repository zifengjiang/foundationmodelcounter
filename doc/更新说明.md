# 重要更新说明 - FoundationModels API

## 📌 更新概述

已将项目升级为使用 FoundationModels 的**正确 API**：`streamResponse(to:generating:includeSchemaInPrompt:options:)`

## 🔄 主要变更

### 1. 架构调整

#### 之前 ❌
```swift
// 错误：尝试在 @Model class 上使用 @Guide
@Model
final class Expense {
    @Guide(description: "...")  // 不兼容！
    var date: Date
}
```

#### 现在 ✅
```swift
// 正确：分离 AI 生成层和持久化层

// AI 生成层 - @Generable struct
@Generable
struct ExpenseInfo: Identifiable {
    @Guide(description: "消费日期，ISO8601 格式")
    var date: String?
    // ... 其他字段
}

// 持久化层 - @Model class
@Model
final class Expense {
    var date: Date
    // ... 其他字段
}
```

### 2. API 调用方式

#### 之前 ❌
```swift
// 使用 generateText() 生成文本，然后手动解析 JSON
var fullResponse = ""
for try await chunk in session.generateText(prompt: prompt) {
    fullResponse += chunk.text
}
let data = cleanedResponse.data(using: .utf8)
let expenseInfo = try decoder.decode(ExpenseInfo.self, from: data)
```

#### 现在 ✅
```swift
// 使用 streamResponse() 直接生成结构化数据
let responseStream = session.streamResponse(
    to: userPrompt,
    generating: [ExpenseInfo].self  // 直接指定输出类型
)

for try await partialResult in responseStream {
    result = partialResult.output.first  // 已经是结构化的对象
}
```

## 📊 架构对比

### 旧架构流程
```
用户输入
  ↓
OCR 识别
  ↓
AI 生成文本（JSON 字符串）
  ↓
手动清理文本
  ↓
JSON 解析
  ↓
ExpenseInfo struct
  ↓
填充到 UI
```

**问题**：
- ❌ JSON 解析容易出错
- ❌ 需要手动清理 AI 输出
- ❌ 格式不规范时会失败
- ❌ 没有利用 FoundationModels 的结构化输出能力

### 新架构流程
```
用户输入
  ↓
OCR 识别
  ↓
AI 生成结构化数据（直接输出 ExpenseInfo）
  ↓
填充到 UI
```

**优势**：
- ✅ 类型安全，编译时检查
- ✅ 无需手动解析 JSON
- ✅ AI 理解 @Guide 描述，输出更准确
- ✅ 利用 FoundationModels 的原生能力
- ✅ 代码更简洁可靠

## 🔑 核心概念

### @Generable 宏

用于标记可被 AI 生成的 struct：

```swift
@Generable
struct ExpenseInfo: Identifiable {
    var id: Int
    // 必须实现 Identifiable
}
```

**要求**：
- 必须是 `struct`（不能是 class）
- 必须实现 `Identifiable` 协议
- 字段可以使用 `@Guide` 添加描述

### @Guide 宏

为字段提供说明，帮助 AI 理解如何填充数据：

```swift
@Guide(description: "消费日期，ISO8601 格式，例如：2025-10-28T14:30:00Z")
var date: String?
```

**最佳实践**：
- 明确格式要求
- 提供示例值
- 说明取值范围
- 解释字段含义

### streamResponse API

生成结构化输出的核心 API：

```swift
func streamResponse<Content>(
    to prompt: Prompt,
    generating type: Content.Type = Content.self,
    includeSchemaInPrompt: Bool = true,
    options: GenerationOptions = GenerationOptions()
) -> sending LanguageModelSession.ResponseStream<Content> where Content : Generable
```

**关键参数**：
- `to`: 用户提示词
- `generating`: 输出类型（必须是数组，如 `[ExpenseInfo].self`）
- `includeSchemaInPrompt`: 是否在提示词中包含 schema（默认 true）
- `options`: 生成选项

## 📝 文件变更

### 修改的文件

#### 1. `Services/AIExpenseAnalyzer.swift`

**主要变更**：
- ✅ `ExpenseInfo` 改为 `@Generable struct`
- ✅ 添加 `@Guide` 描述到每个字段
- ✅ 实现 `Identifiable` 协议
- ✅ 使用 `streamResponse` 替代 `generateText`
- ✅ 移除手动 JSON 解析代码
- ✅ 更新错误处理

#### 2. `Models/Expense.swift`

**主要变更**：
- ✅ 移除 `import FoundationModels`
- ✅ 移除 `@Guide` 宏（只在 @Model 上不支持）
- ✅ 保持 `@Model class` 用于 SwiftData

### 新增的文件

#### `FOUNDATION_MODELS_GUIDE.md`

完整的 FoundationModels API 使用指南，包括：
- @Generable 和 @Model 的区别
- streamResponse API 详解
- @Guide 最佳实践
- 完整示例代码
- 常见错误和解决方案
- 性能优化建议

## 🎯 使用方式

### 在项目中使用

1. **定义 @Generable struct**（已完成）
```swift
@Generable
struct ExpenseInfo: Identifiable {
    var id: Int
    @Guide(description: "...")
    var date: String?
    // ...
}
```

2. **调用 AI 分析**（无需修改调用代码）
```swift
let expenseInfo = try await AIExpenseAnalyzer.shared.analyzeExpense(from: text)
```

3. **使用生成的数据**（无需修改）
```swift
if let dateString = expenseInfo.date {
    // 使用数据
}
```

### 数据流程

```
账单图片
    ↓
OCRService.recognizeText()
    ↓ (返回 String)
AIExpenseAnalyzer.analyzeExpense()
    ↓ (返回 ExpenseInfo - @Generable struct)
填充到 AddExpenseView 的表单
    ↓ (用户确认/修改)
创建 Expense 对象 (@Model class)
    ↓
SwiftData 持久化
```

## 💡 优势总结

### 1. 类型安全
- 编译时检查字段类型
- 自动补全支持
- 减少运行时错误

### 2. 代码简洁
```swift
// 之前：~50 行（JSON 解析 + 清理）
// 现在：~20 行（直接获取结构化数据）
```

### 3. 更准确的输出
- AI 理解 @Guide 描述
- 直接生成目标格式
- 无需中间 JSON 转换

### 4. 更好的错误处理
- 明确的错误类型
- 流式处理支持
- 优雅的失败处理

## 📚 相关文档

- [FOUNDATION_MODELS_GUIDE.md](FOUNDATION_MODELS_GUIDE.md) - **强烈推荐阅读**
- [Apple 官方文档](https://developer.apple.com/documentation/foundationmodels/languagemodelsession/streamresponse(to:generating:includeschemainprompt:options:))
- [PROJECT_SUMMARY.md](PROJECT_SUMMARY.md) - 技术架构总结

## ⚠️ 注意事项

### 兼容性
- 需要 iOS 26.0+
- 需要 Xcode 16.0+
- 需要支持 FoundationModels 的设备

### 迁移提示

如果你基于旧版本修改了代码：

1. **不要在 @Model class 上使用 @Guide**
   - @Guide 只能用于 @Generable struct

2. **generating 参数必须是数组**
   - `[ExpenseInfo].self` ✅
   - `ExpenseInfo.self` ❌

3. **保持数据分离**
   - ExpenseInfo: AI 生成（@Generable struct）
   - Expense: 数据存储（@Model class）

## 🎉 总结

这次更新将项目升级为使用 FoundationModels 的**正确且推荐的 API**，带来了：

- ✅ 更简洁的代码
- ✅ 更可靠的输出
- ✅ 更好的类型安全
- ✅ 更准确的 AI 理解
- ✅ 更优雅的架构

**推荐所有开发者仔细阅读 [FOUNDATION_MODELS_GUIDE.md](FOUNDATION_MODELS_GUIDE.md) 以充分理解新架构！**

---

更新日期：2025-10-28

