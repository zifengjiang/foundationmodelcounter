# 多货币结算功能说明

## 功能概述

应用现在支持多货币记账功能。当添加记账记录时，如果选择的货币不是默认货币，系统会自动根据实时汇率将其转换为默认货币进行存储。

## 核心特性

### 1. 实时汇率转换
- 使用 ExchangeRate-API 获取实时汇率数据
- 支持11种常用货币：人民币(CNY)、美元(USD)、欧元(EUR)、日元(JPY)、英镑(GBP)、港币(HKD)、新台币(TWD)、韩元(KRW)、新加坡元(SGD)、澳元(AUD)、加元(CAD)
- 汇率缓存1小时，减少API调用次数
- 离线备用汇率，确保在网络不可用时仍可使用

### 2. 默认货币设置
- 在"设置"页面可以选择默认货币
- 所有账目的金额统计都使用默认货币
- 默认货币为 CNY（人民币）

### 3. 货币转换提示
在添加账目时：
- 选择非默认货币后，会实时显示转换后的金额
- 显示当前使用的汇率
- 格式：`≈ XXX.XX CNY (汇率: X.XXXX)`

### 4. 原始货币信息保留
系统会保存以下信息：
- **originalAmount**: 用户输入的原始金额（可选，仅在使用非默认货币时保存）
- **originalCurrency**: 用户选择的原始货币（可选，仅在使用非默认货币时保存）
- **amount**: 转换后的金额（默认货币）
- **currency**: 默认货币代码
- **exchangeRate**: 转换时使用的汇率（可选，仅在使用非默认货币时保存）

**注意**：这些字段为可选类型，确保与旧版本数据的兼容性。旧数据会自动识别为使用默认货币。

### 5. 显示优化

#### 列表视图
- 主要显示默认货币金额
- 如果原始货币不同，会显示"原 XX.XX 货币代码"的小字提示

#### 详情视图
- 显示转换后的金额（默认货币）
- 如果原始货币不同，会显示：
  - 原始金额和货币
  - 使用的汇率信息
  - 图标：🔄 表示货币转换

## 技术实现

### 新增文件
- **CurrencyExchangeService.swift**: 汇率服务，处理汇率获取和货币转换

### 修改的文件
1. **Expense.swift**: 扩展数据模型
   - 添加 `originalAmount`、`originalCurrency`、`exchangeRate` 字段

2. **AddExpenseView.swift**: 添加记账页面
   - 集成汇率转换功能
   - 实时显示转换金额
   - 保存时自动转换

3. **SettingsView.swift**: 设置页面
   - 添加默认货币选择器
   - 支持所有可用货币

4. **ContentView.swift**: 主列表视图
   - 更新 ExpenseRow 以显示原始货币信息

5. **ExpenseDetailView.swift**: 详情视图
   - 显示完整的货币转换信息

### API 说明

使用的汇率API：
```
https://v6.exchangerate-api.com/v6/[API_KEY]/latest/[BASE_CURRENCY]
```

返回格式：
```json
{
  "result": "success",
  "base_code": "CNY",
  "conversion_rates": {
    "USD": 0.1404,
    "EUR": 0.1216,
    ...
  }
}
```

## 使用流程

### 设置默认货币
1. 打开"设置"页面
2. 在"常规设置"中选择"默认货币"
3. 选择你想要作为默认的货币
4. 提示：添加记账时，非默认货币会自动转换为默认货币进行存储

### 添加外币账目
1. 点击"添加账目"
2. 输入金额
3. 选择货币（例如：USD）
4. 系统会自动显示转换后的默认货币金额
5. 保存时自动使用实时汇率进行转换

### 查看外币账目
- 在列表中会看到转换后的金额（默认货币）
- 如果原始货币不同，会有小字提示
- 在详情页可以看到完整的转换信息

## 分期功能与多货币

分期功能完全支持多货币：
- 如果使用非默认货币创建分期账单
- 原始金额会按汇率转换为默认货币
- 每期的原始金额也会相应计算
- 所有期数都会保存相同的汇率信息

## 注意事项

1. **汇率实时性**: 汇率每小时更新一次，可能与实际交易汇率有差异
2. **网络需求**: 首次获取汇率需要网络连接，之后可使用缓存或离线汇率
3. **历史记录**: 已保存的记账记录不会因汇率变化而更新金额
4. **分期账单**: 分期账单的货币和金额不可编辑（包括原始货币信息）

## 离线汇率

当无法获取实时汇率时，系统会使用内置的备用汇率：
- 基于2025年的大概汇率值
- 通过人民币作为中间货币进行转换
- 确保应用在离线环境下仍可正常使用

## 故障排除

### 汇率转换失败
- 检查网络连接
- 确认选择的货币在支持列表中
- 系统会自动使用备用汇率，不会阻止记账

### 显示异常
- 重启应用
- 检查是否正确设置了默认货币
- 确认账目数据已正确保存

## 未来计划

- [ ] 支持自定义汇率
- [ ] 汇率历史记录和趋势图
- [ ] 更多货币支持
- [ ] 批量货币转换功能
- [ ] 汇率提醒功能

