# 账单分期功能说明

## 功能概述

账单分期功能允许用户将大额支出按月分期记录，自动计算利息并生成多个月的账单记录。支持等额本息还款方式。

## 核心功能

### 1. 分期设置
- **分期期数**：支持 3、6、9、12、18、24 期
- **年化利率**：支持自定义年化利率（可设置为0实现无息分期）
- **实时预览**：输入金额和利率后，实时显示每期还款金额、总利息和还款总额
- **详细计算**：可查看前3期的本金和利息分解情况
- **已有账单转换**：支持将已录入的普通账单转换为分期账单

### 2. 账单生成
- 自动按月生成对应期数的账单记录
- 每期账单日期自动递增一个月
- 第一期保存账单图片，后续期不重复保存
- 备注自动添加期数标识（如"第1/12期"）

### 3. 分期标识
在账单列表中，分期账单会显示：
- 🏦 信用卡图标
- 期数标识（如"1/12"表示第1期共12期）
- 蓝色背景徽章便于识别

### 4. 分期信息查看
在账单详情和编辑页面，可以查看：
- 原始金额（分期前的总金额）
- 分期期数
- 年化利率
- 每期还款金额
- 总利息
- 还款总额

### 5. 月份切换查看
- **未来账单查看**：支持查看未来12个月的分期账单
- **月份标识**：未来月份显示"未来"橙色标签
- **分期计数**：显示当月分期账单数量（蓝色徽章）
- **快速返回**：非当月时显示"回到本月"按钮
- **左右切换**：使用箭头按钮在不同月份间切换

## 使用方法

### 创建分期账单

**方式一：添加新账单时创建分期**
1. 在"添加账单"页面，输入账单基本信息
2. 在"分期设置"部分，打开"启用分期"开关
3. 选择分期期数（如12期）
4. 输入年化利率（如12.5表示12.5%，输入0表示无息分期）
5. 查看每期还款预览
6. 点击"保存"，系统自动生成所有期数的账单

**方式二：将已有账单转换为分期**
1. 在账单列表中点击已有账单进入详情/编辑页面
2. 在"分期设置"部分，打开"启用分期"开关
3. 选择分期期数和年化利率
4. 查看预览信息
5. 点击"保存"，系统会删除原账单并生成所有期数的分期账单

### 查看分期账单

- **列表查看**：在主页账单列表中，分期账单会显示蓝色徽章和期数（如 🏦 1/12）
- **详情查看**：点击进入账单详情，可以看到完整的分期信息
- **月份切换**：使用月份选择器左右箭头，可以查看未来月份的分期账单
  - 支持查看未来12个月的账单
  - 未来月份会显示"未来"橙色标签
  - 当月如有分期账单，会显示蓝色分期徽章和数量
  - 非当月时可点击"回到本月"快速返回

### 编辑分期账单

分期账单可以编辑以下信息：
- 日期
- 分类（大类、小类）
- 商户
- 备注

**注意**：分期账单的金额和分期信息不可修改，以保证数据一致性。

### 删除分期账单

删除分期账单时，会弹出智能选项菜单：

**选项一：仅删除当前这一期**
- 只删除选中的这一期账单
- 其他期数保持不变
- 适用场景：误记或重复记录

**选项二：删除全部分期**
- 删除所有相关的分期账单（所有期数）
- 彻底清除该笔分期记录
- 适用场景：取消分期或退款

**选项三：提前还清（删除未来期数）**
- 删除所有未来期数的账单
- 将未来期数的总金额合并到当前期
- 备注自动更新为"已提前还清"
- 适用场景：提前还清贷款或分期
- **注意**：最后一期不显示此选项

#### 示例场景

假设你有一笔12期的分期，现在是第3期：

- **删除当前这一期**：只删除第3期，第1、2、4-12期保持不变
- **删除全部分期**：删除所有12期账单
- **提前还清**：删除第4-12期，将这9期的金额（约4788.63元）合并到第3期，第3期备注更新为"已提前还清"

## 计算方式

### 等额本息算法
使用等额本息还款方式，每月还款金额相同。

**计算公式**：
```
每月还款 = 本金 × [月利率 × (1 + 月利率)^期数] / [(1 + 月利率)^期数 - 1]
月利率 = 年化利率 / 12
```

### 示例

假设购买一部手机6000元，分12期，年化利率12%：

- **每月还款**：532.07元
- **总利息**：384.84元
- **还款总额**：6384.84元

每期本金和利息分解：
- 第1期：本金 472.07元，利息 60.00元
- 第2期：本金 476.79元，利息 55.28元
- 第3期：本金 481.56元，利息 50.51元
- ...
- 第12期：本金 526.77元，利息 5.30元

## 数据模型

### Expense 模型新增字段

```swift
// 分期相关字段
var isInstallment: Bool              // 是否为分期账单
var parentExpenseId: UUID?           // 父账单ID（子账单需要）
var installmentPeriods: Int          // 分期总期数
var installmentAnnualRate: Double    // 年化利率（百分比）
var installmentNumber: Int           // 当前是第几期（1-N）
var totalInstallmentAmount: Double   // 分期总金额（原始金额）
```

### 账单关系
- **父账单**：第1期账单，`parentExpenseId` 为 nil
- **子账单**：第2期及以后的账单，`parentExpenseId` 指向第1期账单的ID

## 技术实现

### 核心组件

1. **InstallmentCalculator.swift**：分期计算工具类
   - 计算每期还款金额
   - 计算总利息
   - 计算每期本金和利息分解

2. **AddExpenseView.swift**：添加分期设置UI
   - 分期开关
   - 期数选择
   - 利率输入
   - 实时预览

3. **EditExpenseView.swift**：编辑页面显示分期信息
   - 只读显示分期信息
   - 禁止修改金额

4. **ExpenseDetailView.swift**：详情页面显示分期信息
   - 完整的分期信息展示
   - 折叠式详情查看

5. **ContentView.swift**：列表页面分期标识
   - 蓝色徽章显示期数

## 注意事项

1. **仅支持支出**：分期功能仅适用于支出类型的账单
2. **数据一致性**：分期账单的金额不可修改，确保每期金额一致
3. **批量生成**：保存时一次性生成所有期数的账单
4. **智能删除**：删除分期账单时，系统会提供多种删除选项（仅删除当前期、删除全部、提前还清）
5. **提前还清**：选择提前还清时，未来期数的金额会自动合并到当前期

## 未来优化方向

1. ✅ ~~批量删除：删除父账单时提示是否删除所有关联的子账单~~ (已完成)
2. ✅ ~~提前还款：支持提前还清功能~~ (已完成)
3. 还款进度：添加还款进度可视化展示
4. 其他还款方式：支持等额本金、先息后本等其他还款方式
5. 分期账单关联查询：快速查看同一分期的所有账单
6. 分期调整：支持修改分期参数（期数、利率等）

## 更新日期

2025-10-31

